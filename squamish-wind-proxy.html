<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Squamish Wind Likelihood (Linear ΔT • Vertical Graph)</title>
<style>
  :root {
    --bg:#0b1224; --fg:#f2f4f8; --muted:#9aa3b2; --card:#121a33; --accent:#6ee7ff;
    --day-strong-border:#2ad27a; --day-strong-bg:rgba(42,210,122,0.08);
    --grid:#263158;
    /* palette for 0–25/25–50/50–75/75–100 */
    --c-blue:#60a5fa;   /* blue-400 */
    --c-yellow:#fde68a; /* yellow-300 */
    --c-orange:#fb923c; /* orange-400 */
    --c-red:#f87171;    /* red-400 */
    --stroke-dim:#274d6b;
  }
  html,body{
    margin:0; padding:0; background:var(--bg); color:var(--fg);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
  }
  .wrap { max-width:980px; margin:24px auto; padding:0 16px 32px; }
  header { margin-bottom:12px; }
  h1 { font-size:20px; margin:0 0 6px; }
  p { margin:0 0 8px; color:var(--muted); }
  .tag { font-size:12px; color:var(--muted); }
  .note { font-size:12px; color:var(--muted); margin-top:16px; }

  .col { display:flex; flex-direction:column; gap:16px; align-items:center; }

  .card{
    width:500px; max-width:92vw;
    background:var(--card); border:1px solid #1a2447; border-radius:14px; padding:14px;
    display:flex; flex-direction:column; position:relative;
  }
  .card.day-strong{
    border-color:var(--day-strong-border);
    box-shadow: 0 0 0 2px var(--day-strong-bg);
    background:
      linear-gradient(0deg, var(--day-strong-bg), var(--day-strong-bg)) padding-box,
      var(--card);
  }
  .ribbon{
    position:absolute; left:0; top:0; bottom:0; width:6px;
    background:linear-gradient(180deg, var(--day-strong-border), #1bb36a);
    border-top-left-radius:14px; border-bottom-left-radius:14px;
    display:none;
  }
  .card.day-strong .ribbon{ display:block; }

  .day{ display:flex; align-items:baseline; justify-content:space-between; margin-bottom:8px; gap:12px; }
  .big{ font-weight:700; }
  .bar{ height:8px; background:#0f1730; border-radius:999px; overflow:hidden; margin-bottom:10px; }
  .bar>div{ height:100%; background:var(--accent); width:0%; transition:width .4s ease; }

  .graph-wrap{ margin-top:6px; }
  .graph{ width:100%; height:120px; display:block; border-radius:10px; }
  .gridline{ stroke:var(--grid); stroke-width:1; stroke-dasharray:3 3; }
  .seg { fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; }
  .pt  { r:4; stroke:var(--stroke-dim); }
  .pt-blue   { fill: var(--c-blue); }
  .pt-yellow { fill: var(--c-yellow); stroke:#7a6d25; }
  .pt-orange { fill: var(--c-orange); stroke:#6b3a19; }
  .pt-red    { fill: var(--c-red); stroke:#6b1f1f; }

  .err{ color:#ff8585; }
  code{ background:#0f1730; padding:2px 6px; border-radius:6px; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Squamish Wind Likelihood (proxy via Vancouver–Lillooet ΔT)</h1>
    <p>
      Hourly <strong>ΔT = Lillooet − Vancouver</strong> drives a linear likelihood:
      <code>0% at <span id="minDeltaLabel"></span> °C</code> → <code>100% at <span id="maxDeltaLabel"></span> °C</code>.
      Graph shows <strong>8 AM – 8 PM</strong>; daily % averages only <strong>11 AM – 6 PM</strong>.
    </p>
    <p class="tag">
      Timezone: America/Vancouver • Graph hours: <span id="hoursLabel"></span> • Eval window: <span id="evalLabel"></span> •
      Source: Open-Meteo (hourly temperature_2m) • Range: 10 days
    </p>
    <div id="status" class="tag"></div>
  </header>

  <div id="col" class="col"><!-- cards injected here --></div>

  <div class="note">
    Hover any point to see the hourly percentage. Colors: <span style="color:#60a5fa">blue</span> 0–25 • <span style="color:#fde68a">yellow</span> 25–50 • <span style="color:#fb923c">orange</span> 50–75 • <span style="color:#f87171">red</span> 75–100.
  </div>
</div>

<script>
(async function(){
  // ===== Config =====
  const TZ = 'America/Vancouver';
  const HOURS = Array.from({length: 13}, (_,i)=> 8 + i); // 8..20 inclusive
  const EVAL_START = 11; // 11 AM
  const EVAL_END   = 18; // 6 PM
  const MIN_DELTA = 5;   // °C → 0%
  const MAX_DELTA = 12;  // °C → 100%
  const HORIZON_DAYS = 10;

  const VANCOUVER = { lat: 49.2827, lon: -123.1207 };
  const LILLOOET  = { lat: 50.6869, lon: -121.9420 };

  // UI refs
  const statusEl  = document.getElementById('status');
  const colEl     = document.getElementById('col');
  document.getElementById('hoursLabel').textContent = `${HOURS[0]}:00–${HOURS[HOURS.length-1]}:00`;
  document.getElementById('evalLabel').textContent  = `${String(EVAL_START).padStart(2,'0')}:00–${String(EVAL_END).padStart(2,'0')}:00`;
  document.getElementById('minDeltaLabel').textContent = MIN_DELTA;
  document.getElementById('maxDeltaLabel').textContent = MAX_DELTA;

  await computeAndRender();

  async function computeAndRender(){
    statusEl.textContent = 'Fetching hourly temps…';
    try {
      const [van, lil] = await Promise.all([
        fetchHourly(VANCOUVER.lat, VANCOUVER.lon, TZ, HORIZON_DAYS),
        fetchHourly(LILLOOET.lat,  LILLOOET.lon,  TZ, HORIZON_DAYS)
      ]);
      const perDay = aggregateByDay(van, lil);
      render(perDay);
      statusEl.textContent = 'Done.';
    } catch (e) {
      console.error(e);
      statusEl.innerHTML = `<span class="err">Error: ${e.message}</span>`;
    }
  }

  async function fetchHourly(lat, lon, timezone, days){
    const today = new Date();
    const start_date = toYMD(today);
    const end_date = toYMD(addDays(today, days));
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = new URLSearchParams({
      latitude: lat, longitude: lon,
      hourly: 'temperature_2m',
      timezone, start_date, end_date
    }).toString();
    const r = await fetch(url);
    if (!r.ok) throw new Error(`Open-Meteo ${r.status}`);
    const json = await r.json();
    const res = {};
    const t = json.hourly.time, v = json.hourly.temperature_2m;
    for (let i=0;i<t.length;i++) res[t[i]] = v[i];
    return res;
  }

  function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
  function toYMD(d){
    return new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit' })
      .format(d).replaceAll('/','-');
  }

  // Linear probability per hour; clamp [0,1]
  function probFromDelta(delta){
    if (delta==null||Number.isNaN(delta)) return null;
    const x = (delta - MIN_DELTA) / (MAX_DELTA - MIN_DELTA);
    return Math.max(0, Math.min(1, x));
  }

  // Color bin for p in [0,1]
  function colorForProb(p){
    if (p == null) return 'var(--c-blue)'; // treat missing as low/blue
    if (p < 0.25) return 'var(--c-blue)';
    if (p < 0.50) return 'var(--c-yellow)';
    if (p < 0.75) return 'var(--c-orange)';
    return 'var(--c-red)';
  }
  function pointClassForProb(p){
    if (p == null) return 'pt pt-blue';
    if (p < 0.25) return 'pt pt-blue';
    if (p < 0.50) return 'pt pt-yellow';
    if (p < 0.75) return 'pt pt-orange';
    return 'pt pt-red';
  }

  function aggregateByDay(van, lil){
    const dates = new Set([...Object.keys(van), ...Object.keys(lil)].map(s=>s.slice(0,10)));
    const sortedDates = [...dates].sort();
    const today = toYMD(new Date());
    const nextN = sortedDates.filter(d=>d>=today).slice(0, HORIZON_DAYS);

    return nextN.map(dateStr=>{
      const rows=[]; const probsForEval=[];
      for(const h of HOURS){
        const stamp=`${dateStr}T${String(h).padStart(2,'0')}:00`;
        const tv=van[stamp], tl=lil[stamp];
        const delta=(typeof tv==='number'&&typeof tl==='number')?(tl-tv):null; // Lillooet − Vancouver
        const p=probFromDelta(delta);
        rows.push({hour:`${String(h).padStart(2,'0')}:00`,prob:p});
        if (h >= EVAL_START && h <= EVAL_END && p != null) probsForEval.push(p);
      }
      const probability=probsForEval.length?(probsForEval.reduce((a,b)=>a+b,0)/probsForEval.length):null;
      return {dateStr,rows,probability};
    });
  }

  function render(perDay){
    colEl.textContent = '';
    const frag = document.createDocumentFragment();

    perDay.forEach(day=>{
      const pctNum=day.probability==null?0:Math.round(day.probability*100);
      const pctTxt=day.probability==null?'—':`${pctNum}%`;

      const card=document.createElement('div');
      card.className='card' + (pctNum>75 ? ' day-strong' : '');
      card.innerHTML=`
        <span class="ribbon" aria-hidden="true"></span>
        <div class="day">
          <div class="big">${formatDay(day.dateStr)}</div>
          <div class="tag">${pctTxt}</div>
        </div>
        <div class="bar"><div style="width:${pctNum}%"></div></div>
        <div class="graph-wrap">
          ${svgGraph(day.rows)}
        </div>
      `;
      frag.appendChild(card);
    });
    colEl.appendChild(frag);
  }

  // Build a colored, smooth SVG curve; segments colored by bin; points colored by bin.
  function svgGraph(rows){
    const W = 472;        // inner width for ~500px card
    const H = 100;        // graph height
    const P = 8;          // padding
    const n = rows.length || 0;
    if (!n) return `<div class="tag">No hourly data</div>`;

    // x positions across [P, W-P]
    const step = (W - 2*P) / (n - 1);
    const xs = rows.map((_,i)=> P + i*step);
    // y: invert so 0 at bottom, 1 at top
    const yOf = (p)=> P + (H - 2*P) * (1 - (p ?? 0));
    const ys = rows.map(r => yOf(r.prob ?? 0));

    // Gridlines (25/50/75%)
    const g25 = yOf(0.25), g50 = yOf(0.50), g75 = yOf(0.75);
    const grid = `
      <line class="gridline" x1="${P}" y1="${g25}" x2="${W-P}" y2="${g25}"></line>
      <line class="gridline" x1="${P}" y1="${g50}" x2="${W-P}" y2="${g50}"></line>
      <line class="gridline" x1="${P}" y1="${g75}" x2="${W-P}" y2="${g75}"></line>
    `;

    // Segment-wise Catmull–Rom → cubic Bézier so we can color each segment
    const segs = [];
    for (let i = 0; i < n - 1; i++) {
      const p0 = [ xs[Math.max(i-1,0)],     ys[Math.max(i-1,0)]     ];
      const p1 = [ xs[i],                   ys[i]                   ];
      const p2 = [ xs[i+1],                 ys[i+1]                 ];
      const p3 = [ xs[Math.min(i+2,n-1)],   ys[Math.min(i+2,n-1)]   ];

      const c1x = p1[0] + (p2[0] - p0[0]) / 6;
      const c1y = p1[1] + (p2[1] - p0[1]) / 6;
      const c2x = p2[0] - (p3[0] - p1[0]) / 6;
      const c2y = p2[1] - (p3[1] - p1[1]) / 6;

      const d = `M ${p1[0]} ${p1[1]} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${p2[0]} ${p2[1]}`;
      const pAvg = ((rows[i].prob ?? 0) + (rows[i+1].prob ?? 0)) / 2;
      const color = colorForProb(pAvg);
      segs.push(`<path class="seg" d="${d}" stroke="${color}"></path>`);
    }

    // Points (hover shows just the percentage)
    const points = rows.map((r,i)=>{
      const cls = pointClassForProb(r.prob);
      const cx = xs[i], cy = ys[i];
      const pct = (r.prob==null) ? '—' : (Math.round(r.prob*100)+'%');
      return `<circle class="${cls}" cx="${cx}" cy="${cy}"><title>${pct}</title></circle>`;
    }).join('');

    // hour labels
    const labels = rows.map((r)=>`<span>${r.hour}</span>`).join('');

    return `
      <svg class="graph" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" aria-label="Hourly likelihood line chart">
        ${grid}
        ${segs.join('')}
        ${points}
      </svg>
      <div class="xlabels" style="display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--muted);padding:0 4px;">
        ${labels}
      </div>
    `;
  }

  function formatDay(ymd){ const [y,m,d]=ymd.split('-').map(Number); return new Date(y,m-1,d).toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }
})();
</script>
</body>
</html>
